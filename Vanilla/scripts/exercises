#!/usr/bin/emacs --script
(load (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory) nil 'nomessage)
(straight-use-package 'use-package)

(use-package modular-config
  :straight t
  )

(modular-config-load-modules '(space org))
(unless (shell-command-to-string "pgrep org")
(if (org-google-tasks-check-date)
    (org-google-tasks-get-tokens)
    ))
(require 'notifications)
(with-current-buffer (find-file-noselect "~/Documents/Org/Agenda/exercises.org")
  (let* ((Monday 2)
         (Tuesday 3)
         (Wednesday 4)
         (Thursday 5)
         (Friday 6)
         (Saturday 7)
         (Sunday 8)
         (day (format-time-string "%A" (current-time)))
         (xday '())
         (count '()))
  (setq xday (delete "" (org-table-get-remote-range "Plan" (concat "@2$" (format "%s" (symbol-value (intern day))) "..@>$" (format "%s" (symbol-value (intern day)))))))
  (setq xday (append xday (delete "" (org-table-get-remote-range "Plan" "@2$1..@>$1"))))

(unless (org-google-tasks-check-tasklist-today "Exercises")
  (mapcar (lambda (x)
            (goto-char (org-find-exact-headline-in-buffer x))
            (org-google-tasks-insert-remote-task (car (org-google-tasks-get-tasklist-id-by-name "Exercises")) (org-get-heading) (car (split-string (org-get-entry) "* ")) (org-google-tasks-convert-time (current-time))  t)
            (message "%s" org-google-tasks-temp-task)
            (let* ((parent org-google-tasks-temp-task))
              (when (org-goto-first-child)
                (org-google-tasks-insert-remote-task (car (org-google-tasks-get-tasklist-id-by-name "Exercises")) (org-get-heading) (car (split-string (org-get-entry) "* ")) (org-google-tasks-convert-time (current-time))  t parent)
                (while (org-goto-sibling)
                  (org-google-tasks-insert-remote-task (car (org-google-tasks-get-tasklist-id-by-name "Exercises")) (org-get-heading) (car (split-string (org-get-entry) "* ")) (org-google-tasks-convert-time (current-time))  t parent)
                  ))))  xday)
  
;; (require 'notifications)
(notifications-notify :app-name "Emacs" :title "Exercises" :body (format "%s" (mapcar* (lambda (a b) (format "%s - %s\n" a b)) xday count)))
(princ (format "%s" (mapcar* (lambda (a b) (format "%s - %s\n" a b)) xday count)))
(unless (org-google-tasks-check-tasklist-today "Diet")
  (org-google-tasks-insert-list (mapcar* (lambda (a b) (format "%s - %s\n" a b)) xday count) "Exercises"))
(sleep-for 20)
)))
